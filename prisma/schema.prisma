generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Business {
  id         String   @id @default(cuid())
  name       String
  currency   String   @default("GHS")
  vatEnabled Boolean  @default(false)
  vatNumber  String?
  mode       String   @default("SIMPLE")
  receiptTemplate String @default("THERMAL_80")
  printMode  String   @default("DIRECT_ESC_POS")
  printerName String?
  // Receipt customization fields
  receiptLogoUrl      String?
  receiptHeader       String?
  receiptFooter       String?
  receiptShowVatNumber Boolean @default(true)
  receiptShowAddress   Boolean @default(true)
  socialMediaHandle   String?
  address             String?
  phone               String?
  // Ghana-specific fields
  tinNumber           String?
  momoEnabled         Boolean  @default(false)
  momoProvider        String?
  momoNumber          String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  stores         Store[]
  users          User[]
  customers      Customer[]
  suppliers      Supplier[]
  categories     Category[]
  products       Product[]
  accounts       Account[]
  journalEntries JournalEntry[]
  expenses       Expense[]
  expensePayments ExpensePayment[]
  salesInvoices  SalesInvoice[]
  purchaseInvoices PurchaseInvoice[]
}

model Store {
  id         String   @id @default(cuid())
  businessId String
  name       String
  address    String?
  createdAt  DateTime @default(now())

  business          Business         @relation(fields: [businessId], references: [id])
  tills             Till[]
  inventoryBalances InventoryBalance[]
  stockMovements    StockMovement[]
  stockAdjustments  StockAdjustment[]
  stocktakes        Stocktake[]
  salesInvoices     SalesInvoice[]
  purchaseInvoices  PurchaseInvoice[]
  salesReturns      SalesReturn[]
  purchaseReturns   PurchaseReturn[]
  expenses          Expense[]
  expensePayments   ExpensePayment[]

  @@index([businessId])
}

model Till {
  id        String   @id @default(cuid())
  storeId   String
  name      String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  store         Store          @relation(fields: [storeId], references: [id])
  salesInvoices SalesInvoice[]
  shifts        Shift[]

  @@index([storeId, active])
}

model Shift {
  id                 String    @id @default(cuid())
  tillId             String
  userId             String
  openedAt           DateTime  @default(now())
  closedAt           DateTime?
  openingCashPence   Int       @default(0)
  expectedCashPence  Int       @default(0)
  actualCashPence    Int?
  cardTotalPence     Int       @default(0)
  transferTotalPence Int       @default(0)
  momoTotalPence     Int       @default(0)
  variance           Int?
  notes              String?
  status             String    @default("OPEN")

  till         Till           @relation(fields: [tillId], references: [id])
  user         User           @relation(fields: [userId], references: [id])
  salesInvoices SalesInvoice[]

  @@index([userId, status])
  @@index([tillId, openedAt])
}

model User {
  id           String   @id @default(cuid())
  businessId   String
  name         String
  email        String   @unique
  passwordHash String
  role         String
  active       Boolean  @default(true)
  twoFactorEnabled    Boolean  @default(false)
  twoFactorSecret     String?
  twoFactorTempSecret String?
  createdAt    DateTime @default(now())

  business       Business      @relation(fields: [businessId], references: [id])
  sessions       Session[]
  salesInvoices  SalesInvoice[] @relation("CashierSales")
  stockMovements StockMovement[]
  stockAdjustments StockAdjustment[]
  salesReturns     SalesReturn[]
  purchaseReturns  PurchaseReturn[]
  expenses         Expense[]
  expensePayments  ExpensePayment[]
  shifts           Shift[]
  auditLogs        AuditLog[]
  stocktakes       Stocktake[]
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  lastSeenAt DateTime @default(now())
  expiresAt DateTime

  user User @relation(fields: [userId], references: [id])

  @@index([expiresAt])
  @@index([userId, createdAt])
}

model Customer {
  id         String   @id @default(cuid())
  businessId String
  name       String
  phone      String?
  email      String?
  creditLimitPence Int @default(0)
  createdAt  DateTime @default(now())

  business      Business       @relation(fields: [businessId], references: [id])
  salesInvoices SalesInvoice[]

  @@index([businessId, name])
}

model Supplier {
  id         String   @id @default(cuid())
  businessId String
  name       String
  phone      String?
  email      String?
  creditLimitPence Int @default(0)
  createdAt  DateTime @default(now())

  business         Business         @relation(fields: [businessId], references: [id])
  purchaseInvoices PurchaseInvoice[]

  @@index([businessId, name])
}

model Category {
  id         String   @id @default(cuid())
  businessId String
  name       String
  colour     String   @default("#059669")
  imageUrl   String?
  sortOrder  Int      @default(0)
  createdAt  DateTime @default(now())

  business Business  @relation(fields: [businessId], references: [id])
  products Product[]

  @@unique([businessId, name])
  @@index([businessId, sortOrder])
}

model Product {
  id                    String    @id @default(cuid())
  businessId            String
  categoryId            String?
  sku                   String?
  barcode               String?   @unique
  name                  String
  active                Boolean   @default(true)
  imageUrl              String?
  sellingPriceBasePence Int
  defaultCostBasePence  Int
  vatRateBps            Int       @default(0)
  vatCode               String?
  reorderPointBase      Int       @default(0)
  promoBuyQty           Int       @default(0)
  promoGetQty           Int       @default(0)
  createdAt             DateTime  @default(now())

  business          Business         @relation(fields: [businessId], references: [id])
  category          Category?        @relation(fields: [categoryId], references: [id])
  productUnits      ProductUnit[]
  inventoryBalances InventoryBalance[]
  salesLines        SalesInvoiceLine[]
  purchaseLines     PurchaseInvoiceLine[]
  stockMovements    StockMovement[]
  stockAdjustments  StockAdjustment[]
  stocktakeLines    StocktakeLine[]

  @@unique([businessId, name])
  @@index([businessId, active, createdAt])
  @@index([categoryId])
}

model Unit {
  id         String   @id @default(cuid())
  name       String
  pluralName String
  symbol     String?

  productUnits ProductUnit[]
  salesInvoiceLines SalesInvoiceLine[]
  purchaseInvoiceLines PurchaseInvoiceLine[]
  stockAdjustments   StockAdjustment[]
}

model ProductUnit {
  id               String   @id @default(cuid())
  productId        String
  unitId           String
  isBaseUnit       Boolean  @default(false)
  conversionToBase Int
  createdAt        DateTime @default(now())

  product Product @relation(fields: [productId], references: [id])
  unit    Unit    @relation(fields: [unitId], references: [id])

  @@unique([productId, unitId])
}

model InventoryBalance {
  id             String   @id @default(cuid())
  storeId        String
  productId      String
  qtyOnHandBase  Int      @default(0)
  avgCostBasePence Int    @default(0)
  updatedAt      DateTime @updatedAt

  store   Store   @relation(fields: [storeId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@unique([storeId, productId])
  @@index([productId])
}

model StockMovement {
  id                String             @id @default(cuid())
  storeId           String
  productId         String
  qtyBase           Int
  unitCostBasePence Int?
  type              String
  referenceType     String?
  referenceId       String?
  userId            String?
  createdAt         DateTime           @default(now())

  store   Store   @relation(fields: [storeId], references: [id])
  product Product @relation(fields: [productId], references: [id])
  user    User?   @relation(fields: [userId], references: [id])

  @@index([productId])
  @@index([storeId, createdAt])
}

model StockAdjustment {
  id           String   @id @default(cuid())
  storeId      String
  productId    String
  unitId       String
  qtyInUnit    Int
  qtyBase      Int
  direction    String
  reason       String?
  userId       String
  createdAt    DateTime @default(now())

  store   Store   @relation(fields: [storeId], references: [id])
  product Product @relation(fields: [productId], references: [id])
  unit    Unit    @relation(fields: [unitId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@index([storeId, createdAt])
  @@index([productId, createdAt])
}

model SalesInvoice {
  id             String        @id @default(cuid())
  businessId     String
  storeId        String
  tillId         String
  shiftId        String?
  cashierUserId  String
  customerId     String?
  paymentStatus  String
  dueDate        DateTime?
  discountPence  Int           @default(0)
  subtotalPence  Int
  vatPence       Int
  totalPence     Int
  createdAt      DateTime      @default(now())

  business    Business        @relation(fields: [businessId], references: [id])
  store       Store           @relation(fields: [storeId], references: [id])
  till        Till            @relation(fields: [tillId], references: [id])
  shift       Shift?          @relation(fields: [shiftId], references: [id])
  cashierUser User            @relation("CashierSales", fields: [cashierUserId], references: [id])
  customer    Customer?       @relation(fields: [customerId], references: [id])
  lines       SalesInvoiceLine[]
  payments    SalesPayment[]
  salesReturn SalesReturn?

  @@index([businessId])
  @@index([storeId, createdAt])
  @@index([cashierUserId, createdAt])
  @@index([businessId, paymentStatus, createdAt])
  @@index([customerId, createdAt])
}

model SalesReturn {
  id               String   @id @default(cuid())
  salesInvoiceId   String   @unique
  storeId          String
  userId           String
  type             String
  refundMethod     String?
  refundAmountPence Int @default(0)
  reason           String?
  createdAt        DateTime @default(now())

  salesInvoice SalesInvoice @relation(fields: [salesInvoiceId], references: [id])
  store        Store       @relation(fields: [storeId], references: [id])
  user         User        @relation(fields: [userId], references: [id])

  @@index([storeId, createdAt])
  @@index([userId, createdAt])
}

model SalesInvoiceLine {
  id                String   @id @default(cuid())
  salesInvoiceId    String
  productId         String
  unitId            String
  qtyInUnit         Int
  conversionToBase  Int
  qtyBase           Int
  unitPricePence    Int
  lineDiscountPence Int      @default(0)
  promoDiscountPence Int     @default(0)
  lineSubtotalPence Int
  lineVatPence      Int
  lineTotalPence    Int
  createdAt         DateTime @default(now())

  salesInvoice SalesInvoice @relation(fields: [salesInvoiceId], references: [id])
  product      Product      @relation(fields: [productId], references: [id])
  unit         Unit         @relation(fields: [unitId], references: [id])

  @@index([salesInvoiceId])
  @@index([productId])
}

model SalesPayment {
  id             String        @id @default(cuid())
  salesInvoiceId String
  method         String
  amountPence    Int
  receivedAt     DateTime      @default(now())
  reference      String?

  salesInvoice SalesInvoice @relation(fields: [salesInvoiceId], references: [id])

  @@index([salesInvoiceId, receivedAt])
  @@index([receivedAt])
}

model PurchaseInvoice {
  id             String        @id @default(cuid())
  businessId     String
  storeId        String
  supplierId     String?
  paymentStatus  String
  dueDate        DateTime?
  subtotalPence  Int
  vatPence       Int
  totalPence     Int
  createdAt      DateTime      @default(now())

  business    Business          @relation(fields: [businessId], references: [id])
  store       Store             @relation(fields: [storeId], references: [id])
  supplier    Supplier?         @relation(fields: [supplierId], references: [id])
  lines       PurchaseInvoiceLine[]
  payments    PurchasePayment[]
  purchaseReturn PurchaseReturn?

  @@index([businessId, createdAt])
  @@index([storeId, createdAt])
  @@index([businessId, paymentStatus, createdAt])
  @@index([supplierId, createdAt])
}

model PurchaseReturn {
  id                String   @id @default(cuid())
  purchaseInvoiceId String   @unique
  storeId           String
  userId            String
  type              String
  refundMethod      String?
  refundAmountPence Int @default(0)
  reason            String?
  createdAt         DateTime @default(now())

  purchaseInvoice PurchaseInvoice @relation(fields: [purchaseInvoiceId], references: [id])
  store           Store          @relation(fields: [storeId], references: [id])
  user            User           @relation(fields: [userId], references: [id])

  @@index([storeId, createdAt])
  @@index([userId, createdAt])
}

model PurchaseInvoiceLine {
  id                String   @id @default(cuid())
  purchaseInvoiceId String
  productId         String
  unitId            String
  qtyInUnit         Int
  conversionToBase  Int
  qtyBase           Int
  unitCostPence     Int
  lineSubtotalPence Int
  lineVatPence      Int
  lineTotalPence    Int
  createdAt         DateTime @default(now())

  purchaseInvoice PurchaseInvoice @relation(fields: [purchaseInvoiceId], references: [id])
  product         Product         @relation(fields: [productId], references: [id])
  unit            Unit            @relation(fields: [unitId], references: [id])
}

model PurchasePayment {
  id               String        @id @default(cuid())
  purchaseInvoiceId String
  method           String
  amountPence      Int
  paidAt           DateTime      @default(now())
  reference        String?

  purchaseInvoice PurchaseInvoice @relation(fields: [purchaseInvoiceId], references: [id])

  @@index([purchaseInvoiceId, paidAt])
  @@index([paidAt])
}

model Account {
  id         String      @id @default(cuid())
  businessId String
  code       String
  name       String
  type       String
  createdAt  DateTime    @default(now())

  business     Business     @relation(fields: [businessId], references: [id])
  journalLines JournalLine[]
  expenses     Expense[]

  @@unique([businessId, code])
  @@index([businessId, type])
}

model Expense {
  id          String   @id @default(cuid())
  businessId  String
  storeId     String
  userId      String
  accountId   String
  amountPence Int
  paymentStatus String @default("PAID")
  method      String?
  dueDate     DateTime?
  vendorName  String?
  reference   String?
  attachmentPath String?
  notes       String?
  createdAt   DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id])
  store    Store    @relation(fields: [storeId], references: [id])
  user     User     @relation(fields: [userId], references: [id])
  account  Account  @relation(fields: [accountId], references: [id])
  payments ExpensePayment[]

  @@index([businessId, paymentStatus, createdAt])
  @@index([storeId, createdAt])
  @@index([accountId, createdAt])
}

model ExpensePayment {
  id         String   @id @default(cuid())
  businessId String
  storeId    String
  userId     String
  expenseId  String
  method     String
  amountPence Int
  paidAt     DateTime @default(now())
  reference  String?

  business Business @relation(fields: [businessId], references: [id])
  store    Store    @relation(fields: [storeId], references: [id])
  user     User     @relation(fields: [userId], references: [id])
  expense Expense @relation(fields: [expenseId], references: [id])

  @@index([expenseId, paidAt])
  @@index([businessId, paidAt])
}

model JournalEntry {
  id            String      @id @default(cuid())
  businessId    String
  description   String
  referenceType String?
  referenceId   String?
  entryDate     DateTime    @default(now())
  createdAt     DateTime    @default(now())

  business Business     @relation(fields: [businessId], references: [id])
  lines    JournalLine[]
}

model JournalLine {
  id            String   @id @default(cuid())
  journalEntryId String
  accountId     String
  debitPence    Int
  creditPence   Int
  memo          String?
  createdAt     DateTime @default(now())

  journalEntry JournalEntry @relation(fields: [journalEntryId], references: [id])
  account      Account      @relation(fields: [accountId], references: [id])
}

model Stocktake {
  id         String   @id @default(cuid())
  storeId    String
  userId     String
  status     String   @default("IN_PROGRESS")
  notes      String?
  createdAt  DateTime @default(now())
  completedAt DateTime?

  store Store @relation(fields: [storeId], references: [id])
  user  User  @relation(fields: [userId], references: [id])
  lines StocktakeLine[]

  @@index([storeId, createdAt])
  @@index([status])
}

model StocktakeLine {
  id            String @id @default(cuid())
  stocktakeId   String
  productId     String
  expectedBase  Int
  countedBase   Int
  varianceBase  Int
  adjusted      Boolean @default(false)

  stocktake Stocktake @relation(fields: [stocktakeId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id])

  @@unique([stocktakeId, productId])
  @@index([stocktakeId])
}

model AuditLog {
  id         String   @id @default(cuid())
  businessId String
  userId     String?
  userName   String
  userRole   String
  action     String
  entity     String?
  entityId   String?
  details    String?
  ipAddress  String?
  createdAt  DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([businessId, createdAt])
  @@index([action])
  @@index([userId])
  @@index([businessId, action, createdAt])
}
